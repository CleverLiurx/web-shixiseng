# HTTPS通信（握手）过程是怎样的？

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc1bddb8bfac4994b54b4ecbf5a725e7~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp)

## 1.客户端首次发出请求

由于客户端(如浏览器)对一些加解密算法的支持程度不一样，但是在TLS协议传输过程中必须使用同一套加解密算法才能保证数据能够正常的加解密。在TLS握手阶段，客户端首先要告知服务端，自己支持哪些加密算法，所以客户端需要将`本地支持的加密套件(Cipher Suite)的列表`传送给服务端。除此之外，客户端还要产生一个`随机数`，这个随机数一方面需要在客户端保存，另一方面需要传送给服务端。

客户端需要提供如下信息：

- 支持的协议版本，比如TLS 1.0版
- 一个客户端生成的随机数，稍后用于生成”对话密钥”
- 支持的加密方法，比如RSA公钥加密
- 支持的压缩方法


## 2.服务端首次回应

服务端在接收到客户端的Client Hello之后，服务端需要`确定加密协议的版本`，以及`加密的算法`，然后也生成一个`随机数`，以及将自己的`证书`一并发送给客户端，这里的随机数是整个过程的第二个随机数。

服务端需要提供的信息：

- 协议的版本
- 加密的算法
- 随机数
- 服务器证书


## 3.客户端再次回应

客户端首先会对服务器下发的`证书进行验证`，验证通过之后，则会继续下面的操作，客户端再次产生一个`随机数`（第三个随机数），然后使用服务器证书中的公钥进行加密，以及放一个`ChangeCipherSpec消息`（即编码改变的消息），还有整个前面所有消息的`hash值`，进行服务器验证，然后用新秘钥加密一段数据一并发送到服务器，确保正式通信前无误。 客户端使用前面的两个随机数以及刚刚新生成的新随机数，使用与服务器确定的加密算法，生成一个`Session Secret`。

> ChangeCipherSpec是一个独立的协议，体现在数据包中就是一个字节的数据，用于告知服务端，客户端已经切换到之前协商好的加密套件的状态，准备使用之前协商好的加密套件加密数据并传输了。


## 4.服务器再次响应

服务端在接收到客户端传过来的第三个随机数的 加密数据之后，使用私钥对这段加密数据进行`解密`，并对数据进行验证，也会使用跟客户端同样的方式生成秘钥，一切准备好之后，也会给客户端发送一个`ChangeCipherSpec消息`，告知客户端已经切换到协商过的加密套件状态，准备使用加密套件和 `Session Secret` 加密数据了。之后，服务端也会使用 `Session Secret` 加密一段 `Finish消息`发送给客户端，以验证之前通过握手建立起来的加解密通道是否成功。

## 5.后续客户端与服务器间通信

确定秘钥之后，服务器与客户端之间就会通过商定的秘钥加密消息了，进行通讯了。整个握手过程也就基本完成了。

> 值得特别提出的是： TSL/SSL协议在握手阶段使用的是`非对称加密`，在传输阶段使用的是`对称加密`，也就是说在**TSL/SSL上传送的数据是使用对称密钥加密的！**因为非对称加密的速度缓慢，耗费资源。其实当客户端和主机使用非对称加密方式建立连接后，客户端和主机已经决定好了在传输过程使用的对称加密算法和关键的对称加密密钥，由于这个过程本身是安全可靠的，也即对称加密密钥是不可能被窃取盗用的，因此，保证了在传输过程中对数据进行对称加密也是安全可靠的，因为除了客户端和主机之外，不可能有第三方窃取并解密出对称加密密钥！如果有人窃听通信，他可以知道双方选择的加密方法，以及三个随机数中的两个。整个通话的安全，只取决于第三个随机数能不能被破解。